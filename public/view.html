<!DOCTYPE HTML>
<html>
<head>
  <meta charset="UTF-8">
  <title>Main</title>
  <script src="view.js"></script>
  <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/css/bootstrap.min.css" integrity="sha384-Vkoo8x4CGsO3+Hhxv8T/Q5PaXtkKtu6ug5TOeNV6gBiFeWPGFN9MuhOf23Q9Ifjh" crossorigin="anonymous">
  <link rel="stylesheet" href="style.css">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
</head>

<body id="body">

<div class="container">
  <div class="row">
    <div class="col-sm-12">
      <h1 id="title">youtube-notes</h1>
    </div>
  </div>
  <div class="row">
    <div class="col-md-8">
      <div id="player"></div>
    </div>
    <div class="col-md-4">
      <pre id="elm"></pre>
    </div>
  </div>
  <div class="row">
    <div id="footer" class="col-md-12 text-center">
      <span>Â© 2020 by </span><a href="https://tadityar.me">tadityar</a><span> - </span><a href="https://github.com/tadityar/youtube-notes">source code</a>
    </div>
  </div>
</div>
<script>
// load YT iframe js
var tag = document.createElement('script');

tag.src = "https://www.youtube.com/iframe_api";
var firstScriptTag = document.getElementsByTagName('script')[0];
firstScriptTag.parentNode.insertBefore(tag, firstScriptTag);

const queryString = window.location.search;
const urlParams = new URLSearchParams(queryString);

var id;
if (urlParams.has('noteId')) {
  id = urlParams.get('noteId');
} else {
  id = "";
}

const query = `
query notes_by_pk($id: uuid!) {
  notes_by_pk(id: $id) {
    is_dark_mode
    notes
    title
    id
    videoId
  }
}
`

var hasuraResponse;
var title;
var isDark;
var videoId;
var xhr = new XMLHttpRequest();
xhr.open("POST", 'http://localhost:8080/v1/graphql', false);

//Send the proper header information along with the request
xhr.setRequestHeader("Content-Type", "application/json");
xhr.setRequestHeader("Accept", "application/json");
xhr.send(JSON.stringify({
  query,
  variables: { id }
}));

if (xhr.status === 200) {
  var jsonResponse = JSON.parse(xhr.response);
  hasuraResponse = jsonResponse.data.notes_by_pk;
  document.getElementById("title").textContent = hasuraResponse.title;
  isDark = hasuraResponse.is_dark_mode;
  videoId = hasuraResponse.videoId;
}

if (isDark) {
  document.getElementById("body").classList.add("bg-dark");
  document.getElementById("footer").classList.add("text-light");
  document.getElementById("title").classList.add("text-light");
}

var player;
function onYouTubeIframeAPIReady() {
  player = new YT.Player('player', {
    videoId: videoId,
    events: {
      'onReady': onPlayerReady,
    }
  });
}

// elm-stuff
var flags = {
  currentTime: 0,
  fetchedNote: hasuraResponse,
}
var app = Elm.View.init({
  node: document.getElementById('elm'),
  flags: flags
});
app.ports.seekVideo.subscribe(function(timeStamp) {
  player.seekTo(Number(timeStamp));
});

ready = false;
function onPlayerReady(event) {
  ready = true;
  setInterval(getTimestamp, 500, app, ready)
}

function getTimestamp(app, ready) {
  if (ready) {
    console.log({ currentTime: player.getCurrentTime()})
      app.ports.getTimestamp.send(player.getCurrentTime())
  }
}

</script>

</body>
</html>
